"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.processPagesDir = exports.getPaths = exports.resolveFile = exports.getBaseDir = exports.getConfigPath = void 0;

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/for-each"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _findupSync = _interopRequireDefault(require("findup-sync"));

const CONFIG_FILE_NAME = 'redwood.toml';
const PATH_API_DIR_FUNCTIONS = 'api/src/functions';
const PATH_API_DIR_GRAPHQL = 'api/src/graphql';
const PATH_API_DIR_DB = 'api/prisma';
const PATH_API_DIR_DB_SCHEMA = 'api/prisma/schema.prisma';
const PATH_API_DIR_CONFIG = 'api/src/config';
const PATH_API_DIR_LIB = 'api/src/lib';
const PATH_API_DIR_SERVICES = 'api/src/services';
const PATH_API_DIR_SRC = 'api/src';
const PATH_WEB_ROUTES = 'web/src/Routes'; // .js|.tsx

const PATH_WEB_DIR_LAYOUTS = 'web/src/layouts/';
const PATH_WEB_DIR_PAGES = 'web/src/pages/';
const PATH_WEB_DIR_COMPONENTS = 'web/src/components';
const PATH_WEB_DIR_SRC = 'web/src';
const PATH_WEB_DIR_CONFIG = 'web/config';
const PATH_WEB_DIR_CONFIG_WEBPACK = 'web/config/webpack.config.js';
const PATH_WEB_DIR_CONFIG_POSTCSS = 'web/config/postcss.config.js';
/**
 * Search the parent directories for the Redwood configuration file.
 */

const getConfigPath = () => {
  const configPath = (0, _findupSync.default)(CONFIG_FILE_NAME);

  if (!configPath) {
    throw new Error(`Could not find a "${CONFIG_FILE_NAME}" file, are you sure you're in a Redwood project?`);
  }

  return configPath;
};
/**
 * The Redwood config file is used as an anchor for the base directory of a project.
 */


exports.getConfigPath = getConfigPath;

const getBaseDir = (configPath = getConfigPath()) => {
  return _path.default.dirname(configPath);
};
/**
 * Use this to resolve files when the path to the file is known, but the extension
 * is not.
 */


exports.getBaseDir = getBaseDir;

const resolveFile = (filePath, extensions = ['.js', '.tsx', '.ts']) => {
  for (const extension of extensions) {
    const p = `${filePath}${extension}`;

    if (_fs.default.existsSync(p)) {
      return p;
    }
  }

  return null;
};
/**
 * Path constants that are relevant to a Redwood project.
 */


exports.resolveFile = resolveFile;

const getPaths = (BASE_DIR = getBaseDir()) => {
  const routes = resolveFile(_path.default.join(BASE_DIR, PATH_WEB_ROUTES));
  return {
    base: BASE_DIR,
    api: {
      base: _path.default.join(BASE_DIR, 'api'),
      db: _path.default.join(BASE_DIR, PATH_API_DIR_DB),
      dbSchema: _path.default.join(BASE_DIR, PATH_API_DIR_DB_SCHEMA),
      functions: _path.default.join(BASE_DIR, PATH_API_DIR_FUNCTIONS),
      graphql: _path.default.join(BASE_DIR, PATH_API_DIR_GRAPHQL),
      lib: _path.default.join(BASE_DIR, PATH_API_DIR_LIB),
      config: _path.default.join(BASE_DIR, PATH_API_DIR_CONFIG),
      services: _path.default.join(BASE_DIR, PATH_API_DIR_SERVICES),
      src: _path.default.join(BASE_DIR, PATH_API_DIR_SRC)
    },
    web: {
      routes,
      base: _path.default.join(BASE_DIR, 'web'),
      pages: _path.default.join(BASE_DIR, PATH_WEB_DIR_PAGES),
      components: _path.default.join(BASE_DIR, PATH_WEB_DIR_COMPONENTS),
      layouts: _path.default.join(BASE_DIR, PATH_WEB_DIR_LAYOUTS),
      src: _path.default.join(BASE_DIR, PATH_WEB_DIR_SRC),
      config: _path.default.join(BASE_DIR, PATH_WEB_DIR_CONFIG),
      webpack: _path.default.join(BASE_DIR, PATH_WEB_DIR_CONFIG_WEBPACK),
      postcss: _path.default.join(BASE_DIR, PATH_WEB_DIR_CONFIG_POSTCSS)
    }
  };
};
/**
 * Recursively process the pages directory and return information useful for
 * automated imports.
 */


exports.getPaths = getPaths;

const processPagesDir = (webPagesDir = getPaths().web.pages, prefix = []) => {
  const deps = [];

  const entries = _fs.default.readdirSync(webPagesDir, {
    withFileTypes: true
  }); // Iterate over a dir's entries, recursing as necessary into
  // subdirectories.


  (0, _forEach.default)(entries).call(entries, entry => {
    if (entry.isDirectory()) {
      try {
        // Actual page js or tsx files reside in a directory of the same
        // name (supported by: directory-named-webpack-plugin), so let's
        // construct the filename of the actual Page file.
        // `require.resolve` will throw if a module cannot be found.
        const importPath = _path.default.join(webPagesDir, entry.name, entry.name);

        require.resolve(importPath); // If the Page exists, then construct the dependency object and push it
        // onto the deps array.


        const basename = _path.default.posix.basename(entry.name);

        const importName = prefix.join() + basename; // `src/pages/<PageName>`

        const importFile = ['src', 'pages', ...prefix, basename].join('/');
        deps.push({
          importName,
          importPath,
          const: importName,
          path: _path.default.join(webPagesDir, entry.name),
          importStatement: `const ${importName.split(',').join('')} = { name: '${importName.split(',').join('')}', loader: () => import('${importFile}') }`
        });
      } catch (e) {
        // If the Page doesn't exist then we are in a directory of Page
        // directories, so let's recurse into it and do the whole thing over
        // again.
        const newPrefix = [...prefix, entry.name];
        deps.push(...processPagesDir(_path.default.join(webPagesDir, entry.name), newPrefix));
      }
    }
  });
  return deps;
};

exports.processPagesDir = processPagesDir;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXRocy50cyJdLCJuYW1lcyI6WyJDT05GSUdfRklMRV9OQU1FIiwiUEFUSF9BUElfRElSX0ZVTkNUSU9OUyIsIlBBVEhfQVBJX0RJUl9HUkFQSFFMIiwiUEFUSF9BUElfRElSX0RCIiwiUEFUSF9BUElfRElSX0RCX1NDSEVNQSIsIlBBVEhfQVBJX0RJUl9DT05GSUciLCJQQVRIX0FQSV9ESVJfTElCIiwiUEFUSF9BUElfRElSX1NFUlZJQ0VTIiwiUEFUSF9BUElfRElSX1NSQyIsIlBBVEhfV0VCX1JPVVRFUyIsIlBBVEhfV0VCX0RJUl9MQVlPVVRTIiwiUEFUSF9XRUJfRElSX1BBR0VTIiwiUEFUSF9XRUJfRElSX0NPTVBPTkVOVFMiLCJQQVRIX1dFQl9ESVJfU1JDIiwiUEFUSF9XRUJfRElSX0NPTkZJRyIsIlBBVEhfV0VCX0RJUl9DT05GSUdfV0VCUEFDSyIsIlBBVEhfV0VCX0RJUl9DT05GSUdfUE9TVENTUyIsImdldENvbmZpZ1BhdGgiLCJjb25maWdQYXRoIiwiRXJyb3IiLCJnZXRCYXNlRGlyIiwicGF0aCIsImRpcm5hbWUiLCJyZXNvbHZlRmlsZSIsImZpbGVQYXRoIiwiZXh0ZW5zaW9ucyIsImV4dGVuc2lvbiIsInAiLCJmcyIsImV4aXN0c1N5bmMiLCJnZXRQYXRocyIsIkJBU0VfRElSIiwicm91dGVzIiwiam9pbiIsImJhc2UiLCJhcGkiLCJkYiIsImRiU2NoZW1hIiwiZnVuY3Rpb25zIiwiZ3JhcGhxbCIsImxpYiIsImNvbmZpZyIsInNlcnZpY2VzIiwic3JjIiwid2ViIiwicGFnZXMiLCJjb21wb25lbnRzIiwibGF5b3V0cyIsIndlYnBhY2siLCJwb3N0Y3NzIiwicHJvY2Vzc1BhZ2VzRGlyIiwid2ViUGFnZXNEaXIiLCJwcmVmaXgiLCJkZXBzIiwiZW50cmllcyIsInJlYWRkaXJTeW5jIiwid2l0aEZpbGVUeXBlcyIsImVudHJ5IiwiaXNEaXJlY3RvcnkiLCJpbXBvcnRQYXRoIiwibmFtZSIsInJlcXVpcmUiLCJyZXNvbHZlIiwiYmFzZW5hbWUiLCJwb3NpeCIsImltcG9ydE5hbWUiLCJpbXBvcnRGaWxlIiwicHVzaCIsImNvbnN0IiwiaW1wb3J0U3RhdGVtZW50Iiwic3BsaXQiLCJlIiwibmV3UHJlZml4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQXdDQSxNQUFNQSxnQkFBZ0IsR0FBRyxjQUF6QjtBQUVBLE1BQU1DLHNCQUFzQixHQUFHLG1CQUEvQjtBQUNBLE1BQU1DLG9CQUFvQixHQUFHLGlCQUE3QjtBQUNBLE1BQU1DLGVBQWUsR0FBRyxZQUF4QjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLDBCQUEvQjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLGdCQUE1QjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLGFBQXpCO0FBQ0EsTUFBTUMscUJBQXFCLEdBQUcsa0JBQTlCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsU0FBekI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsZ0JBQXhCLEMsQ0FBeUM7O0FBQ3pDLE1BQU1DLG9CQUFvQixHQUFHLGtCQUE3QjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLGdCQUEzQjtBQUNBLE1BQU1DLHVCQUF1QixHQUFHLG9CQUFoQztBQUNBLE1BQU1DLGdCQUFnQixHQUFHLFNBQXpCO0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUcsWUFBNUI7QUFDQSxNQUFNQywyQkFBMkIsR0FBRyw4QkFBcEM7QUFDQSxNQUFNQywyQkFBMkIsR0FBRyw4QkFBcEM7QUFFQTs7OztBQUdPLE1BQU1DLGFBQWEsR0FBRyxNQUFjO0FBQ3pDLFFBQU1DLFVBQVUsR0FBRyx5QkFBT2xCLGdCQUFQLENBQW5COztBQUNBLE1BQUksQ0FBQ2tCLFVBQUwsRUFBaUI7QUFDZixVQUFNLElBQUlDLEtBQUosQ0FDSCxxQkFBb0JuQixnQkFBaUIsbURBRGxDLENBQU47QUFHRDs7QUFDRCxTQUFPa0IsVUFBUDtBQUNELENBUk07QUFVUDs7Ozs7OztBQUdPLE1BQU1FLFVBQVUsR0FBRyxDQUFDRixVQUFrQixHQUFH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QTdCLENBSkU7QUFLUlMsVUFBQUEsZUFBZSxFQUFHLFNBQVFKLFVBQVUsQ0FDakNLLEtBRHVCLENBQ2pCLEdBRGlCLEVBRXZCckMsSUFGdUIsQ0FFbEIsRUFGa0IsQ0FFZCxlQUFjZ0MsVUFBVSxDQUNqQ0ssS0FEdUIsQ0FDakIsR0FEaUIsRUFFdkJyQyxJQUZ1QixDQUVsQixFQUZrQixDQUVkLDRCQUEyQmlDLFVBQVc7QUFUMUMsU0FBVjtBQVdELE9BekJELENBeUJFLE9BQU9LLENBQVAsRUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBLGNBQU1DLFNBQVMsR0FBRyxDQUFDLEdBQUdwQixNQUFKLEVBQVlLLEtBQUssQ0FBQ0csSUFBbEIsQ0FBbEI7QUFDQVAsUUFBQUEsSUFBSSxDQUFDYyxJQUFMLENBQ0UsR0FBR2pCLGVBQWUsQ0FBQzdCLGNBQUtZLElBQUwsQ0FBVWtCLFdBQVYsRUFBdUJNLEtBQUssQ0FBQ0csSUFBN0IsQ0FBRCxFQUFxQ1ksU0FBckMsQ0FEcEI7QUFHRDtBQUNGO0FBQ0YsR0FyQ00sQ0FBUDtBQXNDQSxTQUFPbkIsSUFBUDtBQUNELENBaERNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBmcyBmcm9tICdmcydcblxuaW1wb3J0IGZpbmRVcCBmcm9tICdmaW5kdXAtc3luYydcblxuZXhwb3J0IGludGVyZmFjZSBOb2RlVGFyZ2V0UGF0aHMge1xuICBiYXNlOiBzdHJpbmdcbiAgZGI6IHN0cmluZ1xuICBkYlNjaGVtYTogc3RyaW5nXG4gIHNyYzogc3RyaW5nXG4gIGZ1bmN0aW9uczogc3RyaW5nXG4gIGdyYXBocWw6IHN0cmluZ1xuICBsaWI6IHN0cmluZ1xuICBzZXJ2aWNlczogc3RyaW5nXG4gIGNvbmZpZzogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnJvd3NlclRhcmdldFBhdGhzIHtcbiAgYmFzZTogc3RyaW5nXG4gIHNyYzogc3RyaW5nXG4gIHJvdXRlczogc3RyaW5nXG4gIHBhZ2VzOiBzdHJpbmdcbiAgY29tcG9uZW50czogc3RyaW5nXG4gIGxheW91dHM6IHN0cmluZ1xuICBjb25maWc6IHN0cmluZ1xuICB3ZWJwYWNrOiBzdHJpbmdcbiAgcG9zdGNzczogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGF0aHMge1xuICBiYXNlOiBzdHJpbmdcbiAgd2ViOiBCcm93c2VyVGFyZ2V0UGF0aHNcbiAgYXBpOiBOb2RlVGFyZ2V0UGF0aHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYWdlc0RlcGVuZGVuY3kge1xuICBpbXBvcnROYW1lOiBzdHJpbmdcbiAgaW1wb3J0UGF0aDogc3RyaW5nXG4gIGNvbnN0OiBzdHJpbmdcbiAgcGF0aDogc3RyaW5nXG4gIGltcG9ydFN0YXRlbWVudDogc3RyaW5nXG59XG5cbmNvbnN0IENPTkZJR19GSUxFX05BTUUgPSAncmVkd29vZC50b21sJ1xuXG5jb25zdCBQQVRIX0FQSV9ESVJfRlVOQ1RJT05TID0gJ2FwaS9zcmMvZnVuY3Rpb25zJ1xuY29uc3QgUEFUSF9BUElfRElSX0dSQVBIUUwgPSAnYXBpL3NyYy9ncmFwaHFsJ1xuY29uc3QgUEFUSF9BUElfRElSX0RCID0gJ2FwaS9wcmlzbWEnXG5jb25zdCBQQVRIX0FQSV9ESVJfREJfU0NIRU1BID0gJ2FwaS9wcmlzbWEvc2NoZW1hLnByaXNtYSdcbmNvbnN0IFBBVEhfQVBJX0RJUl9DT05GSUcgPSAnYXBpL3NyYy9jb25maWcnXG5jb25zdCBQQVRIX0FQSV9ESVJfTElCID0gJ2FwaS9zcmMvbGliJ1xuY29uc3QgUEFUSF9BUElfRElSX1NFUlZJQ0VTID0gJ2FwaS9zcmMvc2VydmljZXMnXG5jb25zdCBQQVRIX0FQSV9ESVJfU1JDID0gJ2FwaS9zcmMnXG5jb25zdCBQQVRIX1dFQl9ST1VURVMgPSAnd2ViL3NyYy9Sb3V0ZXMnIC8vIC5qc3wudHN4XG5jb25zdCBQQVRIX1dFQl9ESVJfTEFZT1VUUyA9ICd3ZWIvc3JjL2xheW91dHMvJ1xuY29uc3QgUEFUSF9XRUJfRElSX1BBR0VTID0gJ3dlYi9zcmMvcGFnZXMvJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTVBPTkVOVFMgPSAnd2ViL3NyYy9jb21wb25lbnRzJ1xuY29uc3QgUEFUSF9XRUJfRElSX1NSQyA9ICd3ZWIvc3JjJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTkZJRyA9ICd3ZWIvY29uZmlnJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTkZJR19XRUJQQUNLID0gJ3dlYi9jb25maWcvd2VicGFjay5jb25maWcuanMnXG5jb25zdCBQQVRIX1dFQl9ESVJfQ09ORklHX1BPU1RDU1MgPSAnd2ViL2NvbmZpZy9wb3N0Y3NzLmNvbmZpZy5qcydcblxuLyoqXG4gKiBTZWFyY2ggdGhlIHBhcmVudCBkaXJlY3RvcmllcyBmb3IgdGhlIFJlZHdvb2QgY29uZmlndXJhdGlvbiBmaWxlLlxuICovXG5leHBvcnQgY29uc3QgZ2V0Q29uZmlnUGF0aCA9ICgpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBjb25maWdQYXRoID0gZmluZFVwKENPTkZJR19GSUxFX05BTUUpXG4gIGlmICghY29uZmlnUGF0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBDb3VsZCBub3QgZmluZCBhIFwiJHtDT05GSUdfRklMRV9OQU1FfVwiIGZpbGUsIGFyZSB5b3Ugc3VyZSB5b3UncmUgaW4gYSBSZWR3b29kIHByb2plY3Q/YFxuICAgIClcbiAgfVxuICByZXR1cm4gY29uZmlnUGF0aFxufVxuXG4vKipcbiAqIFRoZSBSZWR3b29kIGNvbmZpZyBmaWxlIGlzIHVzZWQgYXMgYW4gYW5jaG9yIGZvciB0aGUgYmFzZSBkaXJlY3Rvcnkgb2YgYSBwcm9qZWN0LlxuICovXG5leHBvcnQgY29uc3QgZ2V0QmFzZURpciA9IChjb25maWdQYXRoOiBzdHJpbmcgPSBnZXRDb25maWdQYXRoKCkpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gcGF0aC5kaXJuYW1lKGNvbmZpZ1BhdGgpXG59XG5cbi8qKlxuICogVXNlIHRoaXMgdG8gcmVzb2x2ZSBmaWxlcyB3aGVuIHRoZSBwYXRoIHRvIHRoZSBmaWxlIGlzIGtub3duLCBidXQgdGhlIGV4dGVuc2lvblxuICogaXMgbm90LlxuICovXG5leHBvcnQgY29uc3QgcmVzb2x2ZUZpbGUgPSAoXG4gIGZpbGVQYXRoOiBzdHJpbmcsXG4gIGV4dGVuc2lvbnM6IHN0cmluZ1tdID0gWycuanMnLCAnLnRzeCcsICcudHMnXVxuKTogc3RyaW5nIHwgbnVsbCA9PiB7XG4gIGZvciAoY29uc3QgZXh0ZW5zaW9uIG9mIGV4dGVuc2lvbnMpIHtcbiAgICBjb25zdCBwID0gYCR7ZmlsZVBhdGh9JHtleHRlbnNpb259YFxuICAgIGlmIChmcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICByZXR1cm4gcFxuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbFxufVxuXG4vKipcbiAqIFBhdGggY29uc3RhbnRzIHRoYXQgYXJlIHJlbGV2YW50IHRvIGEgUmVkd29vZCBwcm9qZWN0LlxuICovXG5leHBvcnQgY29uc3QgZ2V0UGF0aHMgPSAoQkFTRV9ESVI6IHN0cmluZyA9IGdldEJhc2VEaXIoKSk6IFBhdGhzID0+IHtcbiAgY29uc3Qgcm91dGVzID0gcmVzb2x2ZUZpbGUocGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX1dFQl9ST1VURVMpKSBhcyBzdHJpbmdcblxuICByZXR1cm4ge1xuICAgIGJhc2U6IEJBU0VfRElSLFxuICAgIGFwaToge1xuICAgICAgYmFzZTogcGF0aC5qb2luKEJBU0VfRElSLCAnYXBpJyksXG4gICAgICBkYjogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX0FQSV9ESVJfREIpLFxuICAgICAgZGJTY2hlbWE6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX0RCX1NDSEVNQSksXG4gICAgICBmdW5jdGlvbnM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX0ZVTkNUSU9OUyksXG4gICAgICBncmFwaHFsOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfQVBJX0RJUl9HUkFQSFFMKSxcbiAgICAgIGxpYjogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX0FQSV9ESVJfTElCKSxcbiAgICAgIGNvbmZpZzogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX0FQSV9ESVJfQ09ORklHKSxcbiAgICAgIHNlcnZpY2VzOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfQVBJX0RJUl9TRVJWSUNFUyksXG4gICAgICBzcmM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX1NSQyksXG4gICAgfSxcbiAgICB3ZWI6IHtcbiAgICAgIHJvdXRlcyxcbiAgICAgIGJhc2U6IHBhdGguam9pbihCQVNFX0RJUiwgJ3dlYicpLFxuICAgICAgcGFnZXM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfRElSX1BBR0VTKSxcbiAgICAgIGNvbXBvbmVudHM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfRElSX0NPTVBPTkVOVFMpLFxuICAgICAgbGF5b3V0czogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX1dFQl9ESVJfTEFZT1VUUyksXG4gICAgICBzcmM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfRElSX1NSQyksXG4gICAgICBjb25maWc6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfRElSX0NPTkZJRyksXG4gICAgICB3ZWJwYWNrOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9DT05GSUdfV0VCUEFDSyksXG4gICAgICBwb3N0Y3NzOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9DT05GSUdfUE9TVENTUyksXG4gICAgfSxcbiAgfVxufVxuXG4vKipcbiAqIFJlY3Vyc2l2ZWx5IHByb2Nlc3MgdGhlIHBhZ2VzIGRpcmVjdG9yeSBhbmQgcmV0dXJuIGluZm9ybWF0aW9uIHVzZWZ1bCBmb3JcbiAqIGF1dG9tYXRlZCBpbXBvcnRzLlxuICovXG5leHBvcnQgY29uc3QgcHJvY2Vzc1BhZ2VzRGlyID0gKFxuICB3ZWJQYWdlc0Rpcjogc3RyaW5nID0gZ2V0UGF0aHMoKS53ZWIucGFnZXMsXG4gIHByZWZpeDogQXJyYXk8c3RyaW5nPiA9IFtdXG4pOiBBcnJheTxQYWdlc0RlcGVuZGVuY3k+ID0+IHtcbiAgY29uc3QgZGVwczogQXJyYXk8UGFnZXNEZXBlbmRlbmN5PiA9IFtdXG4gIGNvbnN0IGVudHJpZXMgPSBmcy5yZWFkZGlyU3luYyh3ZWJQYWdlc0RpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pXG5cbiAgLy8gSXRlcmF0ZSBvdmVyIGEgZGlyJ3MgZW50cmllcywgcmVjdXJzaW5nIGFzIG5lY2Vzc2FyeSBpbnRvXG4gIC8vIHN1YmRpcmVjdG9yaWVzLlxuICBlbnRyaWVzLmZvckVhY2goKGVudHJ5KSA9PiB7XG4gICAgaWYgKGVudHJ5LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEFjdHVhbCBwYWdlIGpzIG9yIHRzeCBmaWxlcyByZXNpZGUgaW4gYSBkaXJlY3Rvcnkgb2YgdGhlIHNhbWVcbiAgICAgICAgLy8gbmFtZSAoc3VwcG9ydGVkIGJ5OiBkaXJlY3RvcnktbmFtZWQtd2VicGFjay1wbHVnaW4pLCBzbyBsZXQnc1xuICAgICAgICAvLyBjb25zdHJ1Y3QgdGhlIGZpbGVuYW1lIG9mIHRoZSBhY3R1YWwgUGFnZSBmaWxlLlxuICAgICAgICAvLyBgcmVxdWlyZS5yZXNvbHZlYCB3aWxsIHRocm93IGlmIGEgbW9kdWxlIGNhbm5vdCBiZSBmb3VuZC5cbiAgICAgICAgY29uc3QgaW1wb3J0UGF0aCA9IHBhdGguam9pbih3ZWJQYWdlc0RpciwgZW50cnkubmFtZSwgZW50cnkubmFtZSlcbiAgICAgICAgcmVxdWlyZS5yZXNvbHZlKGltcG9ydFBhdGgpXG5cbiAgICAgICAgLy8gSWYgdGhlIFBhZ2UgZXhpc3RzLCB0aGVuIGNvbnN0cnVjdCB0aGUgZGVwZW5kZW5jeSBvYmplY3QgYW5kIHB1c2ggaXRcbiAgICAgICAgLy8gb250byB0aGUgZGVwcyBhcnJheS5cbiAgICAgICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLnBvc2l4LmJhc2VuYW1lKGVudHJ5Lm5hbWUpXG4gICAgICAgIGNvbnN0IGltcG9ydE5hbWUgPSBwcmVmaXguam9pbigpICsgYmFzZW5hbWVcbiAgICAgICAgLy8gYHNyYy9wYWdlcy88UGFnZU5hbWU+YFxuICAgICAgICBjb25zdCBpbXBvcnRGaWxlID0gWydzcmMnLCAncGFnZXMnLCAuLi5wcmVmaXgsIGJhc2VuYW1lXS5qb2luKCcvJylcbiAgICAgICAgZGVwcy5wdXNoKHtcbiAgICAgICAgICBpbXBvcnROYW1lLFxuICAgICAgICAgIGltcG9ydFBhdGgsXG4gICAgICAgICAgY29uc3Q6IGltcG9ydE5hbWUsXG4gICAgICAgICAgcGF0aDogcGF0aC5qb2luKHdlYlBhZ2VzRGlyLCBlbnRyeS5uYW1lKSxcbiAgICAgICAgICBpbXBvcnRTdGF0ZW1lbnQ6IGBjb25zdCAke2ltcG9ydE5hbWVcbiAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAuam9pbignJyl9ID0geyBuYW1lOiAnJHtpbXBvcnROYW1lXG4gICAgICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAgICAgLmpvaW4oJycpfScsIGxvYWRlcjogKCkgPT4gaW1wb3J0KCcke2ltcG9ydEZpbGV9JykgfWAsXG4gICAgICAgIH0pXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIElmIHRoZSBQYWdlIGRvZXNuJ3QgZXhpc3QgdGhlbiB3ZSBhcmUgaW4gYSBkaXJlY3Rvcnkgb2YgUGFnZVxuICAgICAgICAvLyBkaXJlY3Rvcmllcywgc28gbGV0J3MgcmVjdXJzZSBpbnRvIGl0IGFuZCBkbyB0aGUgd2hvbGUgdGhpbmcgb3ZlclxuICAgICAgICAvLyBhZ2Fpbi5cbiAgICAgICAgY29uc3QgbmV3UHJlZml4ID0gWy4uLnByZWZpeCwgZW50cnkubmFtZV1cbiAgICAgICAgZGVwcy5wdXNoKFxuICAgICAgICAgIC4uLnByb2Nlc3NQYWdlc0RpcihwYXRoLmpvaW4od2ViUGFnZXNEaXIsIGVudHJ5Lm5hbWUpLCBuZXdQcmVmaXgpXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH0pXG4gIHJldHVybiBkZXBzXG59XG4iXX0=