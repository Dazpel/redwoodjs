"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.requestHandler = exports.parseBody = void 0;

var _keys = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/object/keys"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/for-each"));

var _qs = _interopRequireDefault(require("qs"));

var _error = require("../error");

const parseBody = rawBody => {
  if (typeof rawBody === 'string') {
    return {
      body: rawBody,
      isBase64Encoded: false
    };
  }

  if (rawBody instanceof Buffer) {
    return {
      body: rawBody.toString('base64'),
      isBase64Encoded: true
    };
  }

  return {
    body: '',
    isBase64Encoded: false
  };
};

exports.parseBody = parseBody;

const lambdaEventForExpressRequest = request => {
  return {
    httpMethod: request.method,
    headers: request.headers,
    path: request.path,
    queryStringParameters: _qs.default.parse(request.url.split(/\?(.+)/)[1]),
    requestContext: {
      identity: {
        sourceIp: request.ip
      }
    },
    ...parseBody(request.body) // adds `body` and `isBase64Encoded`

  };
};

const expressResponseForLambdaResult = (expressResFn, lambdaResult) => {
  const {
    statusCode = 200,
    headers,
    body = ''
  } = lambdaResult;

  if (headers) {
    var _context;

    (0, _forEach.default)(_context = (0, _keys.default)(headers)).call(_context, headerName => {
      const headerValue = headers[headerName];
      expressResFn.setHeader(headerName, headerValue);
    });
  }

  expressResFn.status(statusCode); // We're using this to log GraphQL errors, this isn't the right place.
  // I can't seem to get the express middleware to play nicely.

  if (statusCode === 400) {
    try {
      var _b$errors;

      const b = JSON.parse(body);

      if (b === null || b === void 0 ? void 0 : (_b$errors = b.errors) === null || _b$errors === void 0 ? void 0 : _b$errors[0]) {
        const {
          message
        } = b.errors[0];
        const e = new Error(message);
        e.stack = '';
        (0, _error.handleError)(e).then(console.log);
      }
    } catch (e) {// do nothing
    }
  } // The AWS lambda docs specify that the response object must be
  // compatible with `JSON.stringify`, but the type definition specifices that
  // it must be a string.


  if (typeof body === 'string') {
    expressResFn.send(body);
  } else {
    expressResFn.json(body);
  }
};

const expressResponseForLambdaError = (expressResFn, error) => {
  (0, _error.handleError)(error).then(console.log);
  expressResFn.status(500).send();
};

const requestHandler = async (req, res, lambdaFunction) => {
  const {
    routeName
  } = req.params;
  const {
    handler
  } = lambdaFunction; // TODO: Move this to http.

  if (typeof handler !== 'function') {
    const errorMessage = `"${routeName}" does not export a function named "handler"`;
    console.error(errorMessage);
    res.status(500).send(errorMessage);
  } // We take the express request object and convert it into a lambda function event.


  const event = lambdaEventForExpressRequest(req);

  const handlerCallback = expressResFn => (error, lambdaResult) => {
    if (error) {
      expressResponseForLambdaError(expressResFn, error);
      return;
    }

    expressResponseForLambdaResult(expressResFn, lambdaResult);
  }; // Execute the lambda function.
  // https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html


  const handlerPromise = handler(event, {}, // TODO: Add support for context: https://github.com/DefinitelyTyped/DefinitelyTyped/blob/0bb210867d16170c4a08d9ce5d132817651a0f80/types/aws-lambda/index.d.ts#L443-L467
  handlerCallback(res)); // In this case the handlerCallback should not be called.

  if (handlerPromise && typeof handlerPromise.then === 'function') {
    try {
      const lambaResponse = await handlerPromise;
      return expressResponseForLambdaResult(res, lambaResponse);
    } catch (error) {
      return expressResponseForLambdaError(res, error);
    }
  }
};

exports.requestHandler = requestHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXF1ZXN0SGFuZGxlcnMvYXdzTGFtYmRhLnRzIl0sIm5hbWVzIjpbInBhcnNlQm9keSIsInJhd0JvZHkiLCJib2R5IiwiaXNCYXNlNjRFbmNvZGVkIiwiQnVmZmVyIiwidG9TdHJpbmciLCJsYW1iZGFFdmVudEZvckV4cHJlc3NSZXF1ZXN0IiwicmVxdWVzdCIsImh0dHBNZXRob2QiLCJtZXRob2QiLCJoZWFkZXJzIiwicGF0aCIsInF1ZXJ5U3RyaW5nUGFyYW1ldGVycyIsInFzIiwicGFyc2UiLCJ1cmwiLCJzcGxpdCIsInJlcXVlc3RDb250ZXh0IiwiaWRlbnRpdHkiLCJzb3VyY2VJcCIsImlwIiwiZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0IiwiZXhwcmVzc1Jlc0ZuIiwibGFtYmRhUmVzdWx0Iiwic3RhdHVzQ29kZSIsImhlYWRlck5hbWUiLCJoZWFkZXJWYWx1ZSIsInNldEhlYWRlciIsInN0YXR1cyIsImIiLCJKU09OIiwiZXJyb3JzIiwibWVzc2FnZSIsImUiLCJFcnJvciIsInN0YWNrIiwidGhlbiIsImNvbnNvbGUiLCJsb2ciLCJzZW5kIiwianNvbiIsImV4cHJlc3NSZXNwb25zZUZvckxhbWJkYUVycm9yIiwiZXJyb3IiLCJyZXF1ZXN0SGFuZGxlciIsInJlcSIsInJlcyIsImxhbWJkYUZ1bmN0aW9uIiwicm91dGVOYW1lIiwicGFyYW1zIiwiaGFuZGxlciIsImVycm9yTWVzc2FnZSIsImV2ZW50IiwiaGFuZGxlckNhbGxiYWNrIiwiaGFuZGxlclByb21pc2UiLCJsYW1iYVJlc3BvbnNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBRU8sTUFBTUEsU0FBUyxHQUFJQyxPQUFELElBQThCO0FBQ3JELE1BQUksT0FBT0EsT0FBUCxLQUFtQixRQUF2QixFQUFpQztBQUMvQixXQUFPO0FBQUVDLE1BQUFBLElBQUksRUFBRUQsT0FBUjtBQUFpQkUsTUFBQUEsZUFBZSxFQUFFO0FBQWxD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QU1rQixhQUFhLEdBQUcsTUFBTUQsY0FBNUI7QUFDQSxhQUFPaEMsOEJBQThCLENBQUN3QixHQUFELEVBQU1TLGFBQU4sQ0FBckM7QUFDRCxLQUhELENBR0UsT0FBT1osS0FBUCxFQUFjO0FBQ2QsYUFBT0QsNkJBQTZCLENBQUNJLEdBQUQsRUFBTUgsS0FBTixDQUFwQztBQUNEO0FBQ0Y7QUFDRixDQS9DTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgdHlwZSB7IFJlc3BvbnNlLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBxcyBmcm9tICdxcydcblxuaW1wb3J0IHsgaGFuZGxlRXJyb3IgfSBmcm9tICcuLi9lcnJvcidcblxuZXhwb3J0IGNvbnN0IHBhcnNlQm9keSA9IChyYXdCb2R5OiBzdHJpbmcgfCBCdWZmZXIpID0+IHtcbiAgaWYgKHR5cGVvZiByYXdCb2R5ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB7IGJvZHk6IHJhd0JvZHksIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UgfVxuICB9XG4gIGlmIChyYXdCb2R5IGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgcmV0dXJuIHsgYm9keTogcmF3Qm9keS50b1N0cmluZygnYmFzZTY0JyksIGlzQmFzZTY0RW5jb2RlZDogdHJ1ZSB9XG4gIH1cbiAgcmV0dXJuIHsgYm9keTogJycsIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UgfVxufVxuXG5jb25zdCBsYW1iZGFFdmVudEZvckV4cHJlc3NSZXF1ZXN0ID0gKFxuICByZXF1ZXN0OiBSZXF1ZXN0XG4pOiBBUElHYXRld2F5UHJveHlFdmVudCA9PiB7XG4gIHJldHVybiB7XG4gICAgaHR0cE1ldGhvZDogcmVxdWVzdC5tZXRob2QsXG4gICAgaGVhZGVyczogcmVxdWVzdC5oZWFkZXJzLFxuICAgIHBhdGg6IHJlcXVlc3QucGF0aCxcbiAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHFzLnBhcnNlKHJlcXVlc3QudXJsLnNwbGl0KC9cXD8oLispLylbMV0pLFxuICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICBpZGVudGl0eToge1xuICAgICAgICBzb3VyY2VJcDogcmVxdWVzdC5pcCxcbiAgICAgIH0sXG4gICAgfSxcbiAgICAuLi5wYXJzZUJvZHkocmVxdWVzdC5ib2R5KSwgLy8gYWRkcyBgYm9keWAgYW5kIGBpc0Jhc2U2NEVuY29kZWRgXG4gIH0gYXMgQVBJR2F0ZXdheVByb3h5RXZlbnRcbn1cblxuY29uc3QgZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0ID0gKFxuICBleHByZXNzUmVzRm46IFJlc3BvbnNlLFxuICBsYW1iZGFSZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdFxuKSA9PiB7XG4gIGNvbnN0IHsgc3RhdHVzQ29kZSA9IDIwMCwgaGVhZGVycywgYm9keSA9ICcnIH0gPSBsYW1iZGFSZXN1bHRcblxuICBpZiAoaGVhZGVycykge1xuICAgIE9iamVjdC5rZXlzKGhlYWRlcnMpLmZvckVhY2goKGhlYWRlck5hbWUpID0+IHtcbiAgICAgIGNvbnN0IGhlYWRlclZhbHVlOiBhbnkgPSBoZWFkZXJzW2hlYWRlck5hbWVdXG4gICAgICBleHByZXNzUmVzRm4uc2V0SGVhZGVyKGhlYWRlck5hbWUsIGhlYWRlclZhbHVlKVxuICAgIH0pXG4gIH1cbiAgZXhwcmVzc1Jlc0ZuLnN0YXR1cyhzdGF0dXNDb2RlKVxuXG4gIC8vIFdlJ3JlIHVzaW5nIHRoaXMgdG8gbG9nIEdyYXBoUUwgZXJyb3JzLCB0aGlzIGlzbid0IHRoZSByaWdodCBwbGFjZS5cbiAgLy8gSSBjYW4ndCBzZWVtIHRvIGdldCB0aGUgZXhwcmVzcyBtaWRkbGV3YXJlIHRvIHBsYXkgbmljZWx5LlxuICBpZiAoc3RhdHVzQ29kZSA9PT0gNDAwKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGIgPSBKU09OLnBhcnNlKGJvZHkpXG4gICAgICBpZiAoYj8uZXJyb3JzPy5bMF0pIHtcbiAgICAgICAgY29uc3QgeyBtZXNzYWdlIH0gPSBiLmVycm9yc1swXVxuICAgICAgICBjb25zdCBlID0gbmV3IEVycm9yKG1lc3NhZ2UpXG4gICAgICAgIGUuc3RhY2sgPSAnJ1xuICAgICAgICBoYW5kbGVFcnJvcihlKS50aGVuKGNvbnNvbGUubG9nKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gIH1cblxuICAvLyBUaGUgQVdTIGxhbWJkYSBkb2NzIHNwZWNpZnkgdGhhdCB0aGUgcmVzcG9uc2Ugb2JqZWN0IG11c3QgYmVcbiAgLy8gY29tcGF0aWJsZSB3aXRoIGBKU09OLnN0cmluZ2lmeWAsIGJ1dCB0aGUgdHlwZSBkZWZpbml0aW9uIHNwZWNpZmljZXMgdGhhdFxuICAvLyBpdCBtdXN0IGJlIGEgc3RyaW5nLlxuICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7XG4gICAgZXhwcmVzc1Jlc0ZuLnNlbmQoYm9keSlcbiAgfSBlbHNlIHtcbiAgICBleHByZXNzUmVzRm4uanNvbihib2R5KVxuICB9XG59XG5cbmNvbnN0IGV4cHJlc3NSZXNwb25zZUZvckxhbWJkYUVycm9yID0gKFxuICBleHByZXNzUmVzRm46IFJlc3BvbnNlLFxuICBlcnJvcjogRXJyb3JcbikgPT4ge1xuICBoYW5kbGVFcnJvcihlcnJvcikudGhlbihjb25zb2xlLmxvZylcbiAgZXhwcmVzc1Jlc0ZuLnN0YXR1cyg1MDApLnNlbmQoKVxufVxuXG5leHBvcnQgY29uc3QgcmVxdWVzdEhhbmRsZXIgPSBhc3luYyAoXG4gIHJlcTogUmVxdWVzdCxcbiAgcmVzOiBSZXNwb25zZSxcbiAgbGFtYmRhRnVuY3Rpb246IGFueVxuKSA9PiB7XG4gIGNvbnN0IHsgcm91dGVOYW1lIH0gPSByZXEucGFyYW1zXG4gIGNvbnN0IHsgaGFuZGxlciB9ID0gbGFtYmRhRnVuY3Rpb25cblxuICAvLyBUT0RPOiBNb3ZlIHRoaXMgdG8gaHR0cC5cbiAgaWYgKHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYFwiJHtyb3V0ZU5hbWV9XCIgZG9lcyBub3QgZXhwb3J0IGEgZnVuY3Rpb24gbmFtZWQgXCJoYW5kbGVyXCJgXG4gICAgY29uc29sZS5lcnJvcihlcnJvck1lc3NhZ2UpXG4gICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoZXJyb3JNZXNzYWdlKVxuICB9XG5cbiAgLy8gV2UgdGFrZSB0aGUgZXhwcmVzcyByZXF1ZXN0IG9iamVjdCBhbmQgY29udmVydCBpdCBpbnRvIGEgbGFtYmRhIGZ1bmN0aW9uIGV2ZW50LlxuICBjb25zdCBldmVudCA9IGxhbWJkYUV2ZW50Rm9yRXhwcmVzc1JlcXVlc3QocmVxKVxuXG4gIGNvbnN0IGhhbmRsZXJDYWxsYmFjayA9IChleHByZXNzUmVzRm46IFJlc3BvbnNlKSA9PiAoXG4gICAgZXJyb3I6IEVycm9yLFxuICAgIGxhbWJkYVJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0XG4gICkgPT4ge1xuICAgIGlmIChlcnJvcikge1xuICAgICAgZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhRXJyb3IoZXhwcmVzc1Jlc0ZuLCBlcnJvcilcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGV4cHJlc3NSZXNwb25zZUZvckxhbWJkYVJlc3VsdChleHByZXNzUmVzRm4sIGxhbWJkYVJlc3VsdClcbiAgfVxuXG4gIC8vIEV4ZWN1dGUgdGhlIGxhbWJkYSBmdW5jdGlvbi5cbiAgLy8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvbm9kZWpzLXByb2ctbW9kZWwtaGFuZGxlci5odG1sXG4gIGNvbnN0IGhhbmRsZXJQcm9taXNlID0gaGFuZGxlcihcbiAgICBldmVudCxcbiAgICB7fSwgLy8gVE9ETzogQWRkIHN1cHBvcnQgZm9yIGNvbnRleHQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9EZWZpbml0ZWx5VHlwZWQvRGVmaW5pdGVseVR5cGVkL2Jsb2IvMGJiMjEwODY3ZDE2MTcwYzRhMDhkOWNlNWQxMzI4MTc2NTFhMGY4MC90eXBlcy9hd3MtbGFtYmRhL2luZGV4LmQudHMjTDQ0My1MNDY3XG4gICAgaGFuZGxlckNhbGxiYWNrKHJlcylcbiAgKVxuXG4gIC8vIEluIHRoaXMgY2FzZSB0aGUgaGFuZGxlckNhbGxiYWNrIHNob3VsZCBub3QgYmUgY2FsbGVkLlxuICBpZiAoaGFuZGxlclByb21pc2UgJiYgdHlwZW9mIGhhbmRsZXJQcm9taXNlLnRoZW4gPT09ICdmdW5jdGlvbicpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbGFtYmFSZXNwb25zZSA9IGF3YWl0IGhhbmRsZXJQcm9taXNlXG4gICAgICByZXR1cm4gZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0KHJlcywgbGFtYmFSZXNwb25zZSlcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIGV4cHJlc3NSZXNwb25zZUZvckxhbWJkYUVycm9yKHJlcywgZXJyb3IpXG4gICAgfVxuICB9XG59XG4iXX0=